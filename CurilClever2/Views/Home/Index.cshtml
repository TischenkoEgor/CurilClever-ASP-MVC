@using CurilClever2.ViewModels
@model HomePageViewModel
@{
  ViewData["Title"] = "Index";
}
<div class="jumbotron text-center">
  <h2>Index</h2>
</div>
<div class="container">
  <div class="row">
    <div class="col-md-6">
      <h3 class="text-center">Последние новости</h3>
      <table class="table table-striped table-hover" id="lastnewstable">
        <tr>
          <td>Дата</td>
          <td>Описание</td>
          <td>Ссылка</td>
          <td></td>
        </tr>

        @foreach (News news in Model.News)
        {
      <tr>
        <td>@news.Created.ToUniversalTime()</td>

        <td><a asp-controller="News" asp-action="Details" asp-route-id="@news.id">@news.TextShort</a></td>

        <td><a href="@news.ObjectUrl">перейти к объекту</a></td>
        <td></td>
      </tr>
        }
      </table>
      <script type="text/javascript">
        $(function () {
          $("#lastnewstable").sortable({
            items: 'tr:not(tr:first-child)',
            cursor: 'pointer',
            axis: 'y',
            dropOnEmpty: false,
            start: function (e, ui) {
              ui.item.addClass("selected");
            },
            stop: function (e, ui) {
              ui.item.removeClass("selected");
              $(this).find("tr").each(function (index) {
                if (index > 0) {
                  //$(this).find("td").eq(2).html(index);
                }
              });
            }
          });
        });
      </script>
    </div>
    <div class="col-md-6">
      <h3 class="text-center">Состояние базы данных</h3>
      <div id="barcontainer">
        <svg id="mainbar" />
      </div>
      <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
      <style>
        div#barcontainer {
          width: 100%;
          height: 400px;
          margin: auto;
          background-color: #2F4A6D;
        }

        svg {
          width: 100%;
          height: 100%;
        }

        .bar {
          fill: #80cbc4;
        }

        text {
          font-size: 12px;
          fill: #fff;
        }

        path {
          stroke: gray;
        }

        line {
          stroke: gray;
        }

          line#limit {
            stroke: #FED966;
            stroke-width: 3;
            stroke-dasharray: 3 6;
          }

        .grid path {
          stroke-width: 0;
        }

        .grid .tick line {
          stroke: #9FAAAE;
          stroke-opacity: 0.3;
        }

        text.divergence {
          font-size: 14px;
          fill: #2F4A6D;
        }

        text.value {
          font-size: 14px;
        }

        text.title {
          font-size: 22px;
          font-weight: 600;
        }

        text.label {
          font-size: 14px;
          font-weight: 400;
        }

        text.source {
          font-size: 10px;
        }
      </style>

      <script src="https://d3js.org/d3.v5.min.js"></script>
      <script type="text/javascript">
        window.onload = function () {
          const sample = [
              {
                  language: 'Клиенты',
                  value: @Model.CountOfClients,
                  color: '#000000'
              },
              {
                  language: 'Заказы',
                  value: @Model.CountOfOrders,
                  color: '#000000'
              },
              {
                  language: 'Отели',
                  value: @Model.CountOfHotels,
                  color: '#000000'
              },
              {
                  language: 'Коментарии\n к клиентам',
                  value: @Model.CountOfClientComments,
                  color: '#000000'
              },
              {
                  language: 'Коментарии к заказам',
                  value: @Model.CountOfOrders,
                  color: '#000000'
              }
          ];

          const svg = d3.select('svg');
          const svgContainer = d3.select('#container');

          const margin = 80;
          const width = $('#barcontainer').width() - 2 * margin;;//.css('width') - 2 * margin;
          const height = $('#barcontainer').height() - 2 * margin;//.css('height') - 2 * margin;

          const chart = svg.append('g')
              .attr('transform', `translate(${margin}, ${margin})`);

          const xScale = d3.scaleBand()
              .range([0, width])
              .domain(sample.map((s) => s.language))
              .padding(0.4)

          const yScale = d3.scaleLinear()
              .range([height, 0])
              .domain([0, @Model.MaxCount()]);

          // vertical grid lines
          // const makeXLines = () => d3.axisBottom()
          //   .scale(xScale)

          const makeYLines = () => d3.axisLeft()
              .scale(yScale)

          chart.append('g')
              .attr('transform', `translate(0, ${height})`)
              .call(d3.axisBottom(xScale));

          chart.append('g')
              .call(d3.axisLeft(yScale));

          // vertical grid lines
          // chart.append('g')
          //   .attr('class', 'grid')
          //   .attr('transform', `translate(0, ${height})`)
          //   .call(makeXLines()
          //     .tickSize(-height, 0, 0)
          //     .tickFormat('')
          //   )

          chart.append('g')
            .attr('class', 'grid')
            .call(makeYLines()
                .tickSize(-width, 0, 0)
                .tickFormat('')
            )

          const barGroups = chart.selectAll()
            .data(sample)
            .enter()
            .append('g')

          barGroups
          .append('rect')
          .attr('class', 'bar')
          .attr('x', (g) => xScale(g.language))
          .attr('y', (g) => yScale(g.value))
          .attr('height', (g) => height - yScale(g.value))
          .attr('width', xScale.bandwidth())
          .on('mouseenter', function (actual, i) {
              d3.selectAll('.value')
                  .attr('opacity', 0)

              d3.select(this)
                  .transition()
                  .duration(300)
                  .attr('opacity', 0.6)
                  .attr('x', (a) => xScale(a.language) - 5)
                  .attr('width', xScale.bandwidth() + 10)

              const y = yScale(actual.value)

              line = chart.append('line')
                .attr('id', 'limit')
                .attr('x1', 0)
                .attr('y1', y)
                .attr('x2', width)
                .attr('y2', y)

              barGroups.append('text')
                .attr('class', 'divergence')
                .attr('x', (a) => xScale(a.language) + xScale.bandwidth() / 2)
                .attr('y', (a) => yScale(a.value) + 30)
                .attr('fill', 'white')
                .attr('text-anchor', 'middle')
                .text((a, idx) => {
                    const divergence = (a.value - actual.value).toFixed(1)

                    let text = ''
                    if (divergence > 0) text += '+'
                    text += `${divergence}`

                    return idx !== i ? text : '';
                })

          })
          .on('mouseleave', function () {
              d3.selectAll('.value')
                  .attr('opacity', 1)

              d3.select(this)
                  .transition()
                  .duration(300)
                  .attr('opacity', 1)
                  .attr('x', (a) => xScale(a.language))
                  .attr('width', xScale.bandwidth())

              chart.selectAll('#limit').remove()
              chart.selectAll('.divergence').remove()
          })
        // select all the text elements for the xaxis
        svg.selectAll(".tick > text")
        .attr("transform", function(d) {
          return "translate(" + this.getBBox().height * -2 + "," + this.getBBox().height + ")rotate(-20)";
        });
          //barGroups
          //    .append('text')
          //    .attr('class', 'value')
          //    .attr('x', (a) => xScale(a.language) + xScale.bandwidth() / 2)
          //    .attr('y', (a) => yScale(a.value) + 30)
          //    .attr('text-anchor', 'middle')
          //    .text((a) => `${a.value}%`)

          //svg.append('text')
            //  .attr('class', 'label')
           //   .attr('x', -(height / 2) - margin)
           //   .attr('y', margin / 2.4)
           //   .attr('transform', 'rotate(-90)')
           //   .attr('text-anchor', 'middle')
           //   .text('Количество ()')

          //svg.append('text')
          //    .attr('class', 'label')
          //    .attr('x', width / 2 + margin)
          //    .attr('y', height + margin * 1.7)
          //    .attr('text-anchor', 'middle')
          //    .text('Languages')

          //svg.append('text')
          //    .attr('class', 'title')
          //    .attr('x', width / 2 + margin)
          //    .attr('y', 40)
          //    .attr('text-anchor', 'middle')
          //    .text('Most loved programming languages in 2018')

          //svg.append('text')
          //    .attr('class', 'source')
          //    .attr('x', width - margin / 2)
          //    .attr('y', height + margin * 1.7)
          //    .attr('text-anchor', 'start')
          //    .text('Source: Stack Overflow, 2018')
      }
      </script>
    </div>
  </div>
  <div class="row">
    <div class="col-md-12">

      <h3 class="text-center">Последние заявки</h3>
      <table class="table table-striped table-hover">
        <tr>
          <td>Клиент</td>
          <td>Отель</td>
          <td>Даты</td>
          <td>Стомость</td>
          <td></td>

        </tr>

        @foreach (Order order in Model.Orders)
        {
          <tr>
            <td>@order.Client.FIO</td>
            <td>@order.Hotel.Name</td>
            <td>@order.BeginTravelDate.ToShortDateString() - @order.EndTravelDate.ToShortDateString()</td>
            <td>@order.Price</td>
            <td><a asp-controller="Order" asp-action="Details" asp-route-id="@order.id">просмотр</a> </td>
          </tr>
        }
      </table>
    </div>
  </div>
</div>

